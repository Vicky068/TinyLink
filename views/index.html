<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>TinyLink Dashboard</title>
		<script src="https://cdn.tailwindcss.com"></script>
	</head>
	<body class="bg-gradient-to-b from-slate-50 to-white text-gray-800">
		<div class="max-w-6xl mx-auto p-6">
			<header class="mb-6 flex items-center justify-between">
				<div class="flex items-center gap-3">
					<div class="w-12 h-12 rounded-lg bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold">TL</div>
					<div>
						<h1 class="text-3xl font-extrabold tracking-tight">TinyLink</h1>
						<p class="text-sm text-gray-500">Create and manage short links â€” quick, simple, and track clicks.</p>
					</div>
				</div>
				<div class="text-right">
					<a href="/" class="inline-block px-4 py-2 bg-white border border-indigo-600 text-indigo-600 rounded shadow-sm">Dashboard</a>
				</div>
			</header>

			<main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
				<section class="lg:col-span-1 bg-white p-6 rounded-lg shadow">
					<h2 class="text-lg font-semibold mb-3">Create a short link</h2>
					<form id="createForm" class="space-y-3">
						<div>
							<label class="block text-sm text-gray-600">Destination URL</label>
							<input id="urlInput" type="url" placeholder="https://example.com" required
								class="mt-1 w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-200" />
						</div>
						<div>
							<label class="block text-sm text-gray-600">Custom code (optional)</label>
							<input id="codeInput" type="text" placeholder="6-8 alphanumeric (e.g. abc123)"
								class="mt-1 w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-200" />
						</div>
						<div class="flex items-center gap-2">
							<button id="createBtn" class="px-4 py-2 bg-indigo-600 text-white rounded">Create</button>
							<button id="refreshBtn" type="button" class="px-3 py-2 bg-gray-100 rounded">Refresh</button>
							<span id="formMsg" class="text-sm text-gray-600 ml-2"></span>
						</div>
					</form>
					<p class="text-xs text-gray-400 mt-4">Tip: Leave custom code blank to auto-generate a short code.</p>
				</section>

				<section class="lg:col-span-2 bg-white p-4 rounded-lg shadow">
					<div class="flex items-center justify-between mb-4">
						<h2 class="text-lg font-semibold">Links</h2>
						<input id="filterInput" type="text" placeholder="Filter by code or URL"
							class="p-2 border rounded w-64" />
					</div>

						<div class="overflow-x-auto">
							<table class="w-full text-sm text-left table-auto">
								<thead>
									<tr class="text-xs text-gray-500 uppercase border-b">
										<th class="p-3">Short</th>
										<th class="p-3 hide-sm">Target</th>
										<th class="p-3">Clicks</th>
										<th class="p-3 hide-sm">Last Clicked</th>
										<th class="p-3 hide-sm">Created</th>
										<th class="p-3">Actions</th>
									</tr>
								</thead>
								<tbody id="linksTable" class="text-sm"></tbody>
							</table>
						</div>
				</section>
			</main>

			<!-- Toast -->
			<div id="toast" class="tl-toast fixed right-6 bottom-6 bg-gray-800 text-white px-4 py-2 rounded shadow-lg opacity-0"></div>

			<!-- Delete modal -->
			<div id="modalBackdrop" class="fixed inset-0 hidden items-center justify-center tl-modal-backdrop">
				<div id="modal" class="tl-modal bg-white rounded-lg p-6 w-96 shadow-lg">
					<h3 class="text-lg font-semibold">Delete link?</h3>
					<p class="text-sm text-gray-600 mt-2">This will permanently remove the short link and its stats.</p>
					<div class="mt-4 flex justify-end gap-2">
						<button id="cancelModal" class="px-3 py-2 bg-gray-100 rounded">Cancel</button>
						<button id="confirmModal" class="px-3 py-2 bg-red-600 text-white rounded">Delete</button>
					</div>
				</div>
			</div>
		</div>

		<script>
			const apiBase = '/api/links';

			const q = (s) => document.querySelector(s);
			const urlInput = q('#urlInput');
			const codeInput = q('#codeInput');
			const createForm = q('#createForm');
			const createBtn = q('#createBtn');
			const refreshBtn = q('#refreshBtn');
			const formMsg = q('#formMsg');
			const linksTable = q('#linksTable');
			const filterInput = q('#filterInput');
			const toastEl = q('#toast');
			const modalBackdrop = q('#modalBackdrop');
			const confirmModal = q('#confirmModal');
			const cancelModal = q('#cancelModal');
			let pendingDeleteCode = null;

			const isValidCode = (c) => /^[A-Za-z0-9]{6,8}$/.test(c);

			function showToast(msg, timeout = 3000){
				toastEl.textContent = msg;
				toastEl.classList.remove('hide');
				toastEl.classList.add('show');
				toastEl.classList.remove('opacity-0');
				setTimeout(()=>{ toastEl.classList.remove('show'); toastEl.classList.add('hide'); toastEl.classList.add('opacity-0'); }, timeout);
			}

			async function fetchLinks(){
				try{
					const res = await fetch(apiBase);
					const data = await res.json();
					return data;
				}catch(e){
					console.error(e);
					return [];
				}
			}

			function makeShortUrl(code){
				return `${location.origin}/${encodeURIComponent(code)}`;
			}

			function renderLinks(list){
				const filter = filterInput.value.trim().toLowerCase();
				linksTable.innerHTML = '';
				list.filter(l => !filter || l.code.toLowerCase().includes(filter) || l.url.toLowerCase().includes(filter))
					.forEach(link => {
						const tr = document.createElement('tr');
						tr.className = 'border-b hover:bg-gray-50';
						tr.innerHTML = `
							<td class="p-2 align-top"><a class="text-indigo-600 font-medium" href="${makeShortUrl(link.code)}" target="_blank">${link.code}</a>
								<div class="mt-1 text-xs text-gray-500">${makeShortUrl(link.code)}</div>
							</td>
							<td class="p-2 align-top"><a class="text-blue-600 break-all" href="${link.url}" target="_blank">${link.url}</a></td>
							<td class="p-2 align-top">${link.clicks ?? 0}</td>
							<td class="p-2 align-top">${link.last_clicked ? new Date(link.last_clicked).toLocaleString() : '-'}</td>
							<td class="p-2 align-top">${new Date(link.created_at).toLocaleString()}</td>
							<td class="p-2 align-top table-actions">
								<button data-code="${link.code}" class="copyBtn px-2 py-1 bg-green-500 text-white rounded text-xs">Copy</button>
								<a class="px-2 py-1 bg-gray-100 rounded text-xs" href="/stats.html?code=${encodeURIComponent(link.code)}">Stats</a>
								<button data-code="${link.code}" class="delBtn px-2 py-1 bg-red-500 text-white rounded text-xs">Delete</button>
							</td>
						`;
						linksTable.appendChild(tr);
					});
			}

			async function loadAndRender(){
				createBtn.disabled = false;
				formMsg.textContent = '';
				const list = await fetchLinks();
				renderLinks(list);
			}

			createForm.addEventListener('submit', async (e)=>{
				e.preventDefault();
				createBtn.disabled = true;
				formMsg.textContent = '';
				const url = urlInput.value.trim();
				const code = codeInput.value.trim();
				if(!url){ formMsg.textContent = 'URL is required'; createBtn.disabled = false; return; }
				if(code && !isValidCode(code)){ formMsg.textContent = 'Code must be 6-8 alphanumeric characters'; createBtn.disabled = false; return; }

				try{
					const res = await fetch(apiBase, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ url, code: code || undefined }) });
					const body = await res.json();
					if(!res.ok){ formMsg.textContent = body.error || JSON.stringify(body); createBtn.disabled = false; return; }
					showToast('Created ' + body.code);
					urlInput.value = '';
					codeInput.value = '';
					await loadAndRender();
				}catch(err){ console.error(err); formMsg.textContent = 'Network error'; }
				createBtn.disabled = false;
			});

			refreshBtn.addEventListener('click', loadAndRender);
			filterInput.addEventListener('input', async ()=>{ const list = await fetchLinks(); renderLinks(list); });

			// Delegate copy and delete
			linksTable.addEventListener('click', async (e)=>{
				if(e.target.classList.contains('delBtn')){
					pendingDeleteCode = e.target.dataset.code;
					modalBackdrop.classList.remove('hidden');
					modalBackdrop.classList.add('flex');
					setTimeout(()=>{ q('#modal').classList.add('show'); }, 10);
					return;
				}
				if(e.target.classList.contains('copyBtn')){
					const code = e.target.dataset.code;
					const short = makeShortUrl(code);
					try{ await navigator.clipboard.writeText(short); showToast('Copied: ' + short); }catch(err){ console.error(err); showToast('Copy failed'); }
				}
			});

			cancelModal.addEventListener('click', ()=>{
				q('#modal').classList.remove('show');
				q('#modal').classList.add('hide');
				setTimeout(()=>{ modalBackdrop.classList.add('hidden'); modalBackdrop.classList.remove('flex'); }, 160);
				pendingDeleteCode = null;
			});

			confirmModal.addEventListener('click', async ()=>{
				const code = pendingDeleteCode;
				if(!code) return;
				try{
					const res = await fetch(apiBase + '/' + encodeURIComponent(code), { method: 'DELETE' });
					if(res.ok){ showToast('Deleted ' + code); await loadAndRender(); }
					else showToast('Delete failed');
				}catch(err){ console.error(err); showToast('Network error'); }
				q('#modal').classList.remove('show');
				q('#modal').classList.add('hide');
				setTimeout(()=>{ modalBackdrop.classList.add('hidden'); modalBackdrop.classList.remove('flex'); }, 160);
				pendingDeleteCode = null;
			});

			// Initial load
			loadAndRender();
		</script>
	</body>
</html>